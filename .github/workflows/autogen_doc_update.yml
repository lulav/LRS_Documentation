name: copy docs from autogenerated branch
on: 
  push:
    branches: 
      - autogen_*
  # workflow_call:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: resolve branch name and version
        run: |
          echo ${{ github.ref_name }}
          version=$(echo ${{ github.ref_name }} | grep -oP '(?<=\.)v[0-9].*')
          dir_name=$(echo ${{ github.ref_name }} | grep -oP '(?<=autogen_).*' | egrep -o '^[^\.]+')
          echo "version=$version" >> "$GITHUB_ENV"
          echo "dir_name=$dir_name" >> "$GITHUB_ENV"
          echo "branch_name=${{ github.ref_name }}" >> "$GITHUB_ENV"

      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          ref: main

      - name: make new doc version
        run: |
          git fetch
          git rm -r docs_${{ env.dir_name }}/*
          git checkout origin/${{ env.branch_name }} docs_${{ env.dir_name }}
          yarn install
          yarn docusaurus docs:version:docs_${{ env.dir_name }} ${{ env.version }}

      - name: push to main
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add -A
          git commit -m "update docs_${{ env.dir_name }}"
          git push origin main

      - name: delete branch
        run: git push origin --delete ${{ env.branch_name }}

      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v2
        with:
          event-type: event_main_push